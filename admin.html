<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CuraLife - Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #0c4a6e;
      --primary-light: #0891b2;
      --secondary: #059669;
      --accent: #dc2626;
      --text: #2d3748;
      --text-light: #64748b;
      --background: #f8fafc;
      --card-bg: #ffffff;
      --border: #e5e7eb;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: var(--background);
      color: var(--text);
      line-height: 1.6;
    }
    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .site-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
    }
    .navigation {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }
    .nav-link {
      color: white;
      text-decoration: none;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .nav-link:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
    }
    main {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    h2 {
      text-align: center;
      margin-bottom: 2rem;
      color: var(--primary);
    }
    .content-container {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .user-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
    }
    .user-table th, .user-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .user-table th {
      background-color: var(--background);
      font-weight: 600;
      color: var(--text);
    }
    #loading-message, #insights-message {
      text-align: center;
      font-style: italic;
      color: var(--text-light);
    }
    #permission-denied {
      text-align: center;
      color: var(--accent);
      font-weight: bold;
      font-size: 1.2rem;
    }
    .insights-section {
        margin-top: 2rem;
    }
    .insights-section h3 {
        margin-bottom: 1rem;
        color: var(--primary);
    }
    .generate-btn {
        display: block;
        width: fit-content;
        margin: 1.5rem auto;
        padding: 0.75rem 1.5rem;
        background: var(--secondary);
        color: white;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s ease;
    }
    .generate-btn:hover {
        background: #047857;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1 class="site-title">CuraLife</h1>
      <div class="navigation">
        <a href="products.html" class="nav-link">Products</a>
        <a href="#" class="nav-link" id="auth-link">Logout</a>
      </div>
    </div>
  </header>

  <main>
    <h2>Admin Panel</h2>
    <div id="admin-content" class="content-container">
      <div id="permission-denied" style="display: none;">Access Denied. You must be an administrator to view this page.</div>
      <div id="admin-table" style="display: none;">
        <h3>Registered Users</h3>
        <p id="loading-message">Loading user data...</p>
        <table class="user-table" id="users-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Age</th>
              <th>Address</th>
            </tr>
          </thead>
          <tbody id="users-table-body">
            <!-- User data will be dynamically added here -->
          </tbody>
        </table>
        
        <button id="generate-insights-btn" class="generate-btn" style="display: none;">Generate User Insights âœ¨</button>

        <div id="insights-section" class="insights-section" style="display: none;">
          <h3>User Insights</h3>
          <p id="insights-message">Click the button to generate insights.</p>
          <div id="insights-content"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCq4DizgVzK3zOOdh--tkmSqlgNtd2GteI",
      authDomain: "medishop-27098.firebaseapp.com",
      projectId: "medishop-27098",
      storageBucket: "medishop-27098.firebasestorage.app",
      messagingSenderId: "880890490800",
      appId: "1:880890490800:web:d4c03c5cc83720ef723075",
      databaseURL: "https://medishop-27098-default-rtdb.firebaseio.com/"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    
    // API config for Gemini
    const API_KEY = ""; 
    const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + API_KEY;

    const authLink = document.getElementById('auth-link');
    const adminTableDiv = document.getElementById('admin-table');
    const deniedMessageDiv = document.getElementById('permission-denied');
    const loadingMessageDiv = document.getElementById('loading-message');
    const usersTableBody = document.getElementById('users-table-body');
    const generateInsightsBtn = document.getElementById('generate-insights-btn');
    const insightsSection = document.getElementById('insights-section');
    const insightsMessage = document.getElementById('insights-message');
    const insightsContent = document.getElementById('insights-content');
    
    let allUsersData = null;

    auth.onAuthStateChanged(user => {
      if (user && user.email === 'admin@curalife.com') {
        authLink.textContent = 'Logout';
        authLink.onclick = e => {
          e.preventDefault();
          auth.signOut().then(() => {
            // Use a custom message box instead of alert()
            const msgBox = document.createElement('div');
            msgBox.textContent = 'Logged out successfully';
            msgBox.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);padding:20px;background:white;border:1px solid #ccc;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:1000;';
            document.body.appendChild(msgBox);
            setTimeout(() => {
              msgBox.remove();
              window.location.href = 'products.html';
            }, 1000);
          });
        };
        fetchUsers();
      } else {
        // Redirect to login if not an admin, or show permission denied message
        deniedMessageDiv.style.display = 'block';
        adminTableDiv.style.display = 'none';
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 3000);
      }
    });

    function fetchUsers() {
      loadingMessageDiv.style.display = 'block';
      adminTableDiv.style.display = 'block';
      deniedMessageDiv.style.display = 'none';
      
      const usersRef = database.ref('users');
      usersRef.once('value', (snapshot) => {
        const users = snapshot.val();
        loadingMessageDiv.style.display = 'none';
        usersTableBody.innerHTML = '';
        if (users) {
          allUsersData = Object.values(users);
          allUsersData.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${user.name || 'N/A'}</td>
              <td>${user.email || 'N/A'}</td>
              <td>${user.age || 'N/A'}</td>
              <td>${user.deliveryAddress || 'N/A'}</td>
            `;
            usersTableBody.appendChild(row);
          });
          generateInsightsBtn.style.display = 'block';
        } else {
          usersTableBody.innerHTML = '<tr><td colspan="4">No users found.</td></tr>';
          generateInsightsBtn.style.display = 'none';
        }
      }, (error) => {
        loadingMessageDiv.textContent = 'Error loading user data.';
        console.error("Firebase fetch error:", error);
        generateInsightsBtn.style.display = 'none';
      });
    }

    generateInsightsBtn.addEventListener('click', generateUserInsights);

    async function generateUserInsights() {
      if (!allUsersData || allUsersData.length === 0) {
        insightsMessage.textContent = 'No user data to analyze.';
        insightsSection.style.display = 'block';
        return;
      }
      
      insightsSection.style.display = 'block';
      insightsMessage.textContent = 'Generating insights...';
      insightsContent.innerHTML = '';

      const userDataString = JSON.stringify(allUsersData, null, 2);
      
      const prompt = `Analyze the following JSON data of registered users for the CuraLife platform.
      Provide a concise summary focusing on key demographics, age distribution, and any notable patterns or insights. 
      Do not format the output as code, just provide plain text.
      \n\nUser data: ${userDataString}`;

      const payload = {
        contents: [{ parts: [{ text: prompt }] }],
      };

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`API error: ${response.status} - ${JSON.stringify(errorData)}`);
        }

        const result = await response.json();
        const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

        if (generatedText) {
          insightsContent.innerHTML = `<pre>${generatedText}</pre>`;
          insightsMessage.textContent = 'Insights generated.';
        } else {
          insightsMessage.textContent = 'Could not generate insights.';
        }
      } catch (error) {
        console.error('Error generating insights:', error);
        insightsMessage.textContent = 'Error generating insights. Please try again later.';
      }
    }
  </script>
</body>
</html>
